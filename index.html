<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bill Layne Insurance ‚Äì Signature Capture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1a5f7a" />
  <meta name="description" content="Professional electronic signature app for Bill Layne Insurance documents">
  
  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BLI Signature">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js" crossorigin="anonymous"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
    }
  </script>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js" crossorigin="anonymous"></script>

  <!-- Google APIs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root{
      --primary:#1a5f7a;
      --secondary:#457b9d;
      --accent:#a8dadc;
      --bg:#f8f9fa;
      --text:#2c3e50;
      --success:#27ae60;
      --danger:#e74c3c;
      --warning:#f39c12;
      --radius:16px;
      --shadow:0 4px 20px rgba(0,0,0,.1);
      --headerH:72px;
      --toolbarH:80px;
    }

    * {
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }

    html, body {
      height:100%;
      margin:0;
      padding:0;
      overflow-x:hidden;
    }

    body {
      font-family:"Plus Jakarta Sans", system-ui, -apple-system, sans-serif;
      color:var(--text);
      background:var(--bg);
      touch-action: manipulation;
    }

    /* Header */
    .app-header {
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:1000;
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff;
      padding:16px;
      text-align:center;
      box-shadow:var(--shadow);
      height:var(--headerH);
    }

    .app-header h1 {
      margin:0;
      font-weight:700;
      font-size:1.3rem;
      letter-spacing:.5px;
    }

    .subline {
      font-size:.85rem;
      opacity:.9;
      margin-top:4px;
    }

    /* Mobile-optimized toolbar */
    .toolbar {
      position:fixed;
      top:var(--headerH);
      left:0;
      right:0;
      z-index:950;
      background:#fff;
      border-bottom:2px solid #e1e8ed;
      padding:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      height:var(--toolbarH);
    }

    /* Touch-optimized buttons */
    .btn {
      appearance:none;
      border:0;
      border-radius:12px;
      padding:12px 16px;
      font-weight:600;
      font-size:14px;
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      cursor:pointer;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:all 0.2s;
      white-space:nowrap;
    }

    .btn:active {
      transform:scale(0.95);
    }

    .btn:disabled {
      opacity:.5;
      cursor:not-allowed;
    }

    .btn.secondary {
      background:#f0f3f7;
      color:var(--text);
    }

    .btn.success {
      background:linear-gradient(135deg, var(--success), #229954);
    }

    .btn.danger {
      background:linear-gradient(135deg, var(--danger), #c0392b);
    }

    .btn.warning {
      background:linear-gradient(135deg, var(--warning), #e67e22);
    }

    .btn.small {
      padding:8px 12px;
      font-size:13px;
      min-height:36px;
    }

    /* Mode toggle */
    .mode-toggle {
      display:flex;
      background:#f0f3f7;
      border-radius:12px;
      padding:4px;
      gap:4px;
    }

    .mode-btn {
      padding:8px 12px;
      border:0;
      border-radius:8px;
      background:transparent;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      transition:all 0.2s;
      min-height:36px;
    }

    .mode-btn.active {
      background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,.1);
      color:var(--primary);
    }

    /* Pen controls */
    .pen-controls {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px;
      background:#f8fbfc;
      border-radius:8px;
    }

    .pen-controls.hidden {
      display:none;
    }

    .box-controls {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px;
      background:#f8fbfc;
      border-radius:8px;
    }

    .box-controls.hidden {
      display:none !important;
    }

    .color-picker {
      width:32px;
      height:32px;
      border:2px solid #ddd;
      border-radius:8px;
      cursor:pointer;
    }

    .size-slider {
      width:80px;
    }

    /* Page container */
    .pages-container {
      margin-top:calc(var(--headerH) + var(--toolbarH) + 20px);
      padding:16px;
      padding-bottom:150px;
    }

    .page-card {
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-bottom:20px;
      overflow:hidden;
      position:relative;
    }

    .page-header {
      padding:12px 16px;
      background:linear-gradient(90deg, #f8fbfc, #fff);
      border-bottom:1px solid #e1e8ed;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .page-number {
      font-weight:700;
      color:var(--primary);
      font-size:16px;
    }

    .page-wrap {
      position:relative;
      width:100%;
      background:#fff;
      overflow:hidden;
    }

    .render-canvas {
      display:block;
      width:100%;
      height:auto;
      background:#fff;
    }

    .draw-canvas {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      touch-action:none;
      cursor:crosshair;
      z-index:5;
    }

    .draw-canvas.disabled {
      pointer-events:none;
    }

    /* Signature boxes overlay */
    .signature-boxes-layer {
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      z-index:10;
    }

    .signature-box {
      position:absolute;
      border:2px dashed var(--primary);
      background:rgba(26, 95, 122, 0.05);
      border-radius:8px;
      cursor:move;
      transition:background 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:60px;
      min-width:150px;
      pointer-events:auto;
    }

    .signature-box:hover {
      background:rgba(26, 95, 122, 0.1);
      border-color:var(--secondary);
    }

    .signature-box.selected {
      border:2px solid var(--warning);
      background:rgba(243, 156, 18, 0.1);
    }

    .signature-box.signed {
      border:2px solid var(--success);
      background:rgba(39, 174, 96, 0.05);
    }
    
    .signature-box.signed::after {
      content:'‚úì';
      position:absolute;
      top:-12px;
      right:-12px;
      width:24px;
      height:24px;
      background:var(--success);
      color:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      font-size:16px;
    }
    
    /* Date box styles */
    .signature-box[data-box-type="date"] {
      border-color:#457b9d;
      background:rgba(69, 123, 157, 0.05);
    }
    
    .signature-box[data-box-type="date"]:hover {
      background:rgba(69, 123, 157, 0.1);
      border-color:#5a8fb3;
    }
    
    .signature-box[data-box-type="date"].signed {
      border:2px solid #457b9d;
      background:rgba(69, 123, 157, 0.08);
    }
    
    .signature-box[data-box-type="date"].signed::after {
      content:'üìÖ';
      background:#457b9d;
    }
    
    /* Initial box styles */
    .signature-box[data-box-type="initial"] {
      border-color:#5a7a8c;
      background:rgba(90, 122, 140, 0.05);
    }
    
    .signature-box[data-box-type="initial"].signed::after {
      content:'‚úèÔ∏è';
      background:#5a7a8c;
    }
    
    /* Text box styles */
    .signature-box[data-box-type="text"] {
      border-color:#6b46c1;
      background:rgba(107, 70, 193, 0.05);
    }
    
    .signature-box[data-box-type="text"].signed::after {
      content:'üìù';
      background:#6b46c1;
    }
    
    /* Checkbox styles */
    .signature-box[data-box-type="checkbox"] {
      border-color:#10b981;
      background:rgba(16, 185, 129, 0.05);
      border-radius:4px !important;
      min-width:30px !important;
      min-height:30px !important;
    }
    
    .signature-box[data-box-type="checkbox"].signed {
      background:rgba(16, 185, 129, 0.2);
    }
    
    .signature-box[data-box-type="checkbox"].signed::after {
      display:none;
    }
    
    /* Radio button styles */
    .signature-box[data-box-type="radio"] {
      border-color:#f59e0b;
      background:rgba(245, 158, 11, 0.05);
      border-radius:50% !important;
      min-width:30px !important;
      min-height:30px !important;
    }
    
    .signature-box[data-box-type="radio"].signed {
      background:rgba(245, 158, 11, 0.2);
    }
    
    .signature-box[data-box-type="radio"].signed::after {
      display:none;
    }

    .signature-box-label {
      position:absolute;
      top:-24px;
      left:0;
      font-size:12px;
      font-weight:700;
      color:var(--primary);
      background:#fff;
      padding:2px 8px;
      border-radius:4px;
      white-space:nowrap;
    }

    .signature-box-hint {
      color:var(--primary);
      font-size:14px;
      font-weight:600;
      text-align:center;
      pointer-events:none;
      user-select:none;
    }

    .signature-box.signed .signature-box-hint {
      display:none;
    }

    /* Resize handles */
    .resize-handle {
      position:absolute;
      width:12px;
      height:12px;
      background:var(--primary);
      border:2px solid #fff;
      border-radius:50%;
      cursor:nwse-resize;
    }

    .resize-handle.br {
      bottom:-6px;
      right:-6px;
    }

    .resize-handle.bl {
      bottom:-6px;
      left:-6px;
      cursor:nesw-resize;
    }

    .resize-handle.tr {
      top:-6px;
      right:-6px;
      cursor:nesw-resize;
    }

    .resize-handle.tl {
      top:-6px;
      left:-6px;
      cursor:nwse-resize;
    }

    .delete-box-btn {
      position:absolute;
      top:-10px;
      right:-10px;
      width:24px;
      height:24px;
      background:var(--danger);
      color:#fff;
      border:2px solid #fff;
      border-radius:50%;
      cursor:pointer;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:16px;
      font-weight:bold;
    }

    .signature-box.selected .delete-box-btn {
      display:flex;
    }

    .signature-box.selected .resize-handle {
      display:block;
    }

    .signature-box:not(.selected) .resize-handle {
      display:none;
    }

    /* Page navigation */
    .page-nav {
      position:fixed;
      bottom:80px;
      left:50%;
      transform:translateX(-50%);
      background:#fff;
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:8px;
      display:flex;
      gap:8px;
      z-index:900;
    }

    /* Floating action buttons */
    .fab-container {
      position:fixed;
      bottom:100px;
      right:20px;
      z-index:900;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .fab {
      width:56px;
      height:56px;
      border-radius:50%;
      background:linear-gradient(135deg, var(--primary), var(--secondary));
      color:#fff;
      border:0;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
      transition:all 0.2s;
      position:relative;
    }

    .fab span {
      position:absolute;
      bottom:-22px;
      font-size:11px;
      white-space:nowrap;
      color:var(--text);
      font-weight:600;
      text-shadow:0 1px 2px rgba(255,255,255,0.8);
    }

    .fab:active {
      transform:scale(0.9);
    }

    .fab.success {
      background:linear-gradient(135deg, var(--success), #229954);
    }

    .fab.warning {
      background:linear-gradient(135deg, var(--warning), #e67e22);
    }

    /* Modal */
    .modal {
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.5);
      z-index:1100;
      padding:20px;
    }

    .modal.show {
      display:flex;
    }

    .modal-card {
      width:min(500px, 100%);
      background:#fff;
      border-radius:20px;
      box-shadow:0 10px 40px rgba(0,0,0,.2);
      padding:24px;
      max-height:90vh;
      overflow-y:auto;
    }

    .modal h2 {
      margin:0 0 20px;
      color:var(--primary);
      font-size:1.4rem;
    }

    .form-group {
      margin-bottom:20px;
    }

    .form-group label {
      display:block;
      margin-bottom:8px;
      font-weight:600;
      color:var(--text);
    }

    .form-group input,
    .form-group textarea {
      width:100%;
      padding:12px;
      border:2px solid #e1e8ed;
      border-radius:10px;
      font-size:16px;
      background:#f8fbfc;
      transition:all 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline:none;
      border-color:var(--primary);
      background:#fff;
    }

    .checkbox-group {
      display:flex;
      align-items:flex-start;
      gap:12px;
      margin:20px 0;
    }

    .checkbox-group input[type="checkbox"] {
      width:24px;
      height:24px;
      margin-top:2px;
      cursor:pointer;
    }

    .consent-text {
      background:#f0f8ff;
      border:2px solid var(--accent);
      border-radius:12px;
      padding:16px;
      margin:20px 0;
      font-size:14px;
      line-height:1.6;
    }

    .modal-actions {
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:24px;
    }

    /* Status bar */
    .status-bar {
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#fff;
      border-top:2px solid #e1e8ed;
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index:940;
      box-shadow:0 -2px 8px rgba(0,0,0,.08);
    }

    .status-chip {
      padding:8px 16px;
      border-radius:20px;
      font-weight:600;
      font-size:14px;
    }

    .status-chip.success {
      background:#d4edda;
      color:#155724;
    }

    .status-chip.warning {
      background:#fff3cd;
      color:#856404;
    }

    /* Toast */
    .toast {
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:var(--text);
      color:#fff;
      padding:16px 24px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      z-index:1200;
      display:none;
      font-weight:600;
      font-size:16px;
      max-width:90%;
      text-align:center;
    }

    .toast.show {
      display:block;
      animation:slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity:0;
        transform:translate(-50%, -40%);
      }
      to {
        opacity:1;
        transform:translate(-50%, -50%);
      }
    }

    /* Download options */
    .download-options {
      padding:20px;
      background:#f8fbfc;
      border-radius:12px;
      margin-top:20px;
    }

    .download-options h3 {
      margin:0 0 16px;
      color:var(--primary);
      font-size:1.1rem;
    }

    .option-toggle {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 0;
      border-bottom:1px solid #e1e8ed;
    }

    .option-toggle:last-child {
      border-bottom:none;
    }

    .option-toggle label {
      font-weight:600;
      color:var(--text);
      flex:1;
    }

    .toggle-switch {
      width:48px;
      height:28px;
      background:#ddd;
      border-radius:14px;
      position:relative;
      cursor:pointer;
      transition:background 0.3s;
    }

    .toggle-switch input {
      display:none;
    }

    .toggle-switch input:checked + .toggle-slider {
      transform:translateX(20px);
      background:var(--primary);
    }

    .toggle-switch input:checked ~ .toggle-bg {
      background:var(--accent);
    }

    .toggle-bg {
      position:absolute;
      inset:0;
      background:#ddd;
      border-radius:14px;
      transition:background 0.3s;
    }

    .toggle-slider {
      position:absolute;
      top:2px;
      left:2px;
      width:24px;
      height:24px;
      background:#fff;
      border-radius:50%;
      transition:all 0.3s;
      box-shadow:0 2px 4px rgba(0,0,0,.2);
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .toolbar {
        padding:8px;
        gap:6px;
        height:auto;
        min-height:var(--toolbarH);
      }

      .btn {
        padding:10px 12px;
        font-size:13px;
      }

      .mode-toggle {
        width:100%;
      }

      .pen-controls {
        width:100%;
      }

      .modal-card {
        padding:20px;
        border-radius:16px;
      }
      
      .fab-container {
        bottom:95px;
      }
    }

    /* Print styles */
    @media print {
      .app-header, .toolbar, .fab-container, .status-bar, .modal, .page-nav {
        display:none !important;
      }
      
      .pages-container {
        margin-top:0;
        padding:0;
      }

      .signature-boxes-layer {
        display:none;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <h1>Bill Layne Insurance ‚Äì Signature Capture</h1>
    <div class="subline">Draw ‚Ä¢ Add Boxes ‚Ä¢ Sign Documents</div>
  </header>

  <!-- Main Toolbar -->
  <div class="toolbar">
    <div class="mode-toggle">
      <button class="mode-btn active" id="penMode">‚úèÔ∏è Pen</button>
      <button class="mode-btn" id="boxMode">üì¶ Boxes</button>
      <button class="mode-btn" id="signMode">‚úçÔ∏è Sign</button>
    </div>

    <div class="pen-controls" id="penControls">
      <input type="color" class="color-picker" id="penColor" value="#0b1d29">
      <input type="range" class="size-slider" id="penSize" min="1" max="10" value="2">
      <span style="font-size:12px; font-weight:600;">Size</span>
    </div>

    <div class="box-controls hidden" id="boxControls" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <button class="btn small secondary" id="addSignatureBox" title="Full Signature">‚úçÔ∏è Signature</button>
      <button class="btn small secondary" id="addInitialBox" title="Initials">‚úèÔ∏è Initials</button>
      <button class="btn small secondary" id="addDateBox" title="Date">üìÖ Date</button>
      <button class="btn small secondary" id="addTextBox" title="Text Input">üìù Text</button>
      <button class="btn small secondary" id="addCheckbox" title="Checkbox">‚òëÔ∏è Check</button>
      <button class="btn small secondary" id="addRadioGroup" title="Radio Button">‚≠ï Radio</button>
      <span style="font-size:11px; color:#666; width:100%;">Click on page to place</span>
    </div>

    <button id="btnOpenFile" class="btn secondary small">
      üìÅ Open
    </button>

    <select id="templateSelector" class="btn secondary small" style="padding: 8px 12px; border-radius: 12px; border: none; background: #f0f3f7; min-height: 36px;">
      <option value="">üìã Templates</option>
      <optgroup label="Auto Insurance">
        <option value="nc_grange_auto">NC Grange Auto</option>
        <option value="progressive_auto">Progressive Auto</option>
        <option value="national_gen_auto">National Gen Auto</option>
        <option value="auto_claim">Auto Claim</option>
      </optgroup>
      <optgroup label="Home Insurance">
        <option value="nationwide_home">Nationwide Home</option>
        <option value="travelers_home">Travelers Home</option>
        <option value="home_insurance">Home Application</option>
        <option value="home_claim">Home Claim</option>
      </optgroup>
      <optgroup label="Specialty Insurance">
        <option value="foremost_mobile">Foremost Mobile</option>
        <option value="alamance_farm">Alamance Farm</option>
      </optgroup>
      <optgroup label="General Forms">
        <option value="consent_form">Consent Form</option>
        <option value="no_loss">No Loss Letter</option>
        <option value="cancellation">Cancellation</option>
      </optgroup>
      <option value="__divider__" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
      <option value="__manage__">‚öôÔ∏è Manage Templates...</option>
    </select>
    
    <button id="btnSaveTemplate" class="btn success small" style="display:none;">
      üíæ Save as Template
    </button>

    <button id="btnClear" class="btn danger small" disabled>
      Clear
    </button>

    <button id="btnUndo" class="btn secondary small" disabled>
      Undo
    </button>
  </div>

  <!-- Pages Container -->
  <main class="pages-container" id="pagesContainer"></main>

  <!-- Page Navigation -->
  <div class="page-nav" id="pageNav" style="display:none;">
    <button id="btnPrevPage" class="btn secondary small">‚¨ÖÔ∏è Prev</button>
    <span id="pageIndicator" style="padding:0 16px; font-weight:600;">1/1</span>
    <button id="btnNextPage" class="btn secondary small">Next ‚û°Ô∏è</button>
  </div>

  <!-- Floating Action Buttons -->
  <div class="fab-container">
    <button id="fabDownload" class="fab warning" title="Quick Download PDF">
      ‚¨áÔ∏è
      <span>Download</span>
    </button>
    <button id="fabPrint" class="fab" title="Print Document">
      üñ®Ô∏è
      <span>Print</span>
    </button>
    <button id="fabSave" class="fab success" title="Save Options">
      üíæ
      <span>Save</span>
    </button>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span id="pageStatus" class="status-chip warning">No PDF loaded</span>
    <span id="consentStatus" class="status-chip warning">Not signed</span>
  </div>

  <!-- Hidden file input -->
  <input id="fileInput" type="file" accept="application/pdf" hidden />

  <!-- Consent Modal -->
  <div id="consentModal" class="modal">
    <div class="modal-card">
      <h2>Electronic Signature Consent</h2>
      
      <div class="form-group">
        <label>Full Name *</label>
        <input id="signerName" type="text" placeholder="Enter your full name" />
      </div>

      <div class="form-group">
        <label>Policy Number (Optional)</label>
        <input id="policyNumber" type="text" placeholder="e.g., NC-123456" />
      </div>

      <div class="form-group">
        <label>Phone Number (Optional)</label>
        <input id="phoneNumber" type="text" placeholder="e.g., 336-835-1993" />
      </div>

      <div class="consent-text">
        <strong>Electronic Signature Agreement:</strong><br>
        By checking the box below, I consent to use electronic records and signatures in place of paper documents and handwritten signatures. I understand that my electronic signature is legally binding and has the same legal force as a handwritten signature.
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="consentCheck" />
        <label for="consentCheck">I agree to sign this document electronically</label>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="hideModal('consentModal')">Cancel</button>
        <button id="btnConsent" class="btn success" disabled>Agree & Continue</button>
      </div>
    </div>
  </div>

  <!-- Download Options Modal -->
  <div id="downloadModal" class="modal">
    <div class="modal-card">
      <h2>Save Your Signed Document</h2>
      
      <div class="download-options">
        <h3>What would you like to download?</h3>
        
        <div class="option-toggle">
          <label>Signed PDF Document</label>
          <div class="toggle-switch">
            <input type="checkbox" id="downloadPdf" checked disabled />
            <div class="toggle-bg"></div>
            <div class="toggle-slider"></div>
          </div>
        </div>

        <div class="option-toggle">
          <label>Signature Confirmation Page</label>
          <div class="toggle-switch">
            <input type="checkbox" id="downloadConfirmation" checked />
            <div class="toggle-bg"></div>
            <div class="toggle-slider"></div>
          </div>
        </div>

        <div class="option-toggle">
          <label>Include Audit Trail (appended to PDF)</label>
          <div class="toggle-switch">
            <input type="checkbox" id="downloadAudit" checked />
            <div class="toggle-bg"></div>
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Save to:</label>
        <div style="display:flex; gap:12px;">
          <button id="btnDownloadLocal" class="btn success" style="flex:1">
            üì± Download to Device
          </button>
          <button id="btnSaveDrive" class="btn" style="flex:1">
            ‚òÅÔ∏è Save to Drive
          </button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="hideModal('downloadModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Template Management Modal -->
  <div id="templateModal" class="modal">
    <div class="modal-card" style="max-width: 600px;">
      <h2>üìã Template Management</h2>
      
      <div class="form-group">
        <h3>Create New Template</h3>
        <p style="font-size: 14px; color: #666; margin: 10px 0;">
          1. Load your PDF document<br>
          2. Add all signature boxes where needed<br>
          3. Click "Save Current as Template" below
        </p>
        <input type="text" id="newTemplateName" placeholder="Enter template name (e.g., NC Grange App)" style="margin-bottom: 10px;">
        <button class="btn success" onclick="saveCurrentAsTemplate()">üíæ Save Current as Template</button>
      </div>

      <div class="form-group" style="margin-top: 30px;">
        <h3>Your Custom Templates</h3>
        <div id="customTemplatesList" style="max-height: 200px; overflow-y: auto;">
          <!-- Custom templates will be listed here -->
        </div>
      </div>

      <div class="form-group" style="margin-top: 30px;">
        <h3>Import/Export Templates</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn secondary" onclick="exportTemplates()">üì§ Export All</button>
          <button class="btn secondary" onclick="document.getElementById('importTemplateFile').click()">üì• Import</button>
          <input type="file" id="importTemplateFile" accept=".json" style="display:none;" onchange="importTemplates(event)">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="hideModal('templateModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Configuration
    const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com";
    const GOOGLE_API_KEY = "YOUR_GOOGLE_API_KEY";
    const GOOGLE_APP_ID = "YOUR_APP_ID";
    const GOOGLE_SCOPES = "https://www.googleapis.com/auth/drive.file";

    // State
    let currentPdfBytes = null;
    let pdfDoc = null;
    let pagesState = [];
    let currentMode = 'pen'; // 'pen', 'box', or 'sign'
    let consent = { given: false, name: '', policy: '', phone: '', timestamp: null };
    let signatureBoxes = [];
    let selectedBox = null;
    let currentPageIndex = 0;
    let accessToken = null;
    let currentDrawing = false;
    let penColor = '#0b1d29';
    let penSize = 2;
    let undoStack = [];
    let confirmationId = null;
    let nextBoxType = 'signature'; // 'signature', 'initial', 'date', 'text', 'checkbox', 'radio'
    let radioGroups = {}; // Track radio button groups

    // UI Elements
    const el = id => document.getElementById(id);
    const pagesContainer = el('pagesContainer');
    const fileInput = el('fileInput');
    const toast = el('toast');
    const consentModal = el('consentModal');
    const downloadModal = el('downloadModal');
    const pageStatus = el('pageStatus');
    const consentStatus = el('consentStatus');
    const signerName = el('signerName');
    const policyNumber = el('policyNumber');
    const phoneNumber = el('phoneNumber');
    const consentCheck = el('consentCheck');
    const btnConsent = el('btnConsent');
    const penMode = el('penMode');
    const boxMode = el('boxMode');
    const signMode = el('signMode');
    const penControls = el('penControls');
    const boxControls = el('boxControls');
    const penColorInput = el('penColor');
    const penSizeInput = el('penSize');
    const addSignatureBoxBtn = el('addSignatureBox');
    const addInitialBoxBtn = el('addInitialBox');
    const addDateBoxBtn = el('addDateBox');
    const addTextBoxBtn = el('addTextBox');
    const addCheckboxBtn = el('addCheckbox');
    const addRadioGroupBtn = el('addRadioGroup');
    const btnClear = el('btnClear');
    const btnUndo = el('btnUndo');
    const fabSave = el('fabSave');
    const fabPrint = el('fabPrint');
    const fabDownload = el('fabDownload');
    const btnOpenFile = el('btnOpenFile');
    const templateSelector = el('templateSelector');
    const btnDownloadLocal = el('btnDownloadLocal');
    const btnSaveDrive = el('btnSaveDrive');
    const pageNav = el('pageNav');
    const pageIndicator = el('pageIndicator');
    const btnPrevPage = el('btnPrevPage');
    const btnNextPage = el('btnNextPage');

    // Utility functions
    function generateConfirmationId() {
      const timestamp = Date.now().toString(36).toUpperCase();
      const random = Math.random().toString(36).substr(2, 5).toUpperCase();
      return `BLI-${timestamp}-${random}`;
    }

    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function showModal(modalId) {
      el(modalId).classList.add('show');
    }

    function hideModal(modalId) {
      el(modalId).classList.remove('show');
    }

    // Mode switching
    penMode.addEventListener('click', () => setMode('pen'));
    boxMode.addEventListener('click', () => setMode('box'));
    signMode.addEventListener('click', () => setMode('sign'));

    function setMode(mode) {
      currentMode = mode;
      
      // Update button states
      [penMode, boxMode, signMode].forEach(btn => btn.classList.remove('active'));
      
      // Hide all controls first
      penControls.classList.add('hidden');
      boxControls.classList.add('hidden');
      
      if (mode === 'pen') {
        penMode.classList.add('active');
        penControls.classList.remove('hidden');
        showToast('Pen mode: Draw anywhere on the document');
      } else if (mode === 'box') {
        boxMode.classList.add('active');
        boxControls.classList.remove('hidden');
        // Default to signature box when entering box mode
        nextBoxType = 'signature';
        addSignatureBoxBtn.classList.add('success');
        addDateBoxBtn.classList.remove('success');
        showToast('Box mode: Add signature or date boxes');
      } else if (mode === 'sign') {
        signMode.classList.add('active');
        showToast('Sign mode: Click boxes to sign');
      }
      
      updateCanvasInteraction();
    }

    function updateCanvasInteraction() {
      document.querySelectorAll('.draw-canvas').forEach(canvas => {
        if (currentMode === 'pen') {
          canvas.classList.remove('disabled');
          canvas.style.pointerEvents = 'auto';
          canvas.style.zIndex = '15';
        } else {
          canvas.classList.add('disabled');
          canvas.style.pointerEvents = 'none';
          canvas.style.zIndex = '5';
        }
      });

      document.querySelectorAll('.signature-box').forEach(box => {
        if (currentMode === 'box') {
          box.style.pointerEvents = 'auto';
          box.style.cursor = 'move';
        } else if (currentMode === 'sign') {
          box.style.pointerEvents = 'auto';
          box.style.cursor = 'pointer';
        } else {
          box.style.pointerEvents = 'none';
        }
      });

      document.querySelectorAll('.signature-boxes-layer').forEach(layer => {
        layer.style.pointerEvents = (currentMode === 'box') ? 'auto' : 'none';
      });
    }

    // Pen controls
    penColorInput.addEventListener('change', (e) => {
      penColor = e.target.value;
    });

    penSizeInput.addEventListener('input', (e) => {
      penSize = parseInt(e.target.value);
    });

    // Box type controls - helper function to clear all selections
    function clearBoxTypeSelection() {
      [addSignatureBoxBtn, addInitialBoxBtn, addDateBoxBtn, addTextBoxBtn, 
       addCheckboxBtn, addRadioGroupBtn].forEach(btn => btn.classList.remove('success'));
    }

    addSignatureBoxBtn.addEventListener('click', () => {
      nextBoxType = 'signature';
      clearBoxTypeSelection();
      addSignatureBoxBtn.classList.add('success');
      showToast('Click on page to place signature box');
    });

    addInitialBoxBtn.addEventListener('click', () => {
      nextBoxType = 'initial';
      clearBoxTypeSelection();
      addInitialBoxBtn.classList.add('success');
      showToast('Click on page to place initials box');
    });

    addDateBoxBtn.addEventListener('click', () => {
      nextBoxType = 'date';
      clearBoxTypeSelection();
      addDateBoxBtn.classList.add('success');
      showToast('Click on page to place date box');
    });

    addTextBoxBtn.addEventListener('click', () => {
      nextBoxType = 'text';
      clearBoxTypeSelection();
      addTextBoxBtn.classList.add('success');
      showToast('Click on page to place text input box');
    });

    addCheckboxBtn.addEventListener('click', () => {
      nextBoxType = 'checkbox';
      clearBoxTypeSelection();
      addCheckboxBtn.classList.add('success');
      showToast('Click on page to place checkbox');
    });

    addRadioGroupBtn.addEventListener('click', () => {
      nextBoxType = 'radio';
      clearBoxTypeSelection();
      addRadioGroupBtn.classList.add('success');
      const groupName = prompt('Enter radio button group name (e.g., "option1"):');
      if (groupName) {
        radioGroups.currentGroup = groupName;
        showToast(`Click to place radio button for "${groupName}"`);
      }
    });

    // Template selector
    templateSelector.addEventListener('change', (e) => {
      const value = e.target.value;
      
      if (value === '__manage__') {
        showModal('templateModal');
        updateTemplatesList();
        e.target.value = '';
        return;
      }
      
      if (value && value !== '__divider__' && value !== '__divider2__') {
        if (pagesState.length > 0) {
          applyTemplate(value);
          e.target.value = ''; // Reset selector
        } else {
          showToast('Please load a PDF first');
          e.target.value = '';
        }
      }
    });

    // File handling
    btnOpenFile.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      
      try {
        const arrayBuffer = await file.arrayBuffer();
        await loadPdf(arrayBuffer, file.name);
        showToast('PDF loaded successfully');
      } catch (err) {
        showToast('Failed to load PDF');
        console.error(err);
      }
    });

    async function loadPdf(arrayBuffer, fileName = 'document.pdf') {
      // Ensure we have a proper Uint8Array
      currentPdfBytes = new Uint8Array(arrayBuffer);
      console.log('loadPdf: Loaded PDF bytes:', currentPdfBytes.length);
      console.log('loadPdf: PDF header:', Array.from(currentPdfBytes.slice(0, 5)).map(b => String.fromCharCode(b)).join(''));
      
      pagesContainer.innerHTML = '';
      pagesState = [];
      signatureBoxes = [];
      currentPageIndex = 0;

      // Create a copy for PDF.js to avoid any mutation
      const pdfJsBytes = new Uint8Array(currentPdfBytes);
      const loadingTask = pdfjsLib.getDocument({ data: pdfJsBytes });
      pdfDoc = await loadingTask.promise;

      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i);
        await renderPage(page, i);
      }

      pageStatus.textContent = `${pdfDoc.numPages} pages loaded`;
      pageStatus.className = 'status-chip success';
      btnClear.disabled = false;
      btnUndo.disabled = false;

      // Show page navigation if multiple pages
      if (pdfDoc.numPages > 1) {
        pageNav.style.display = 'flex';
        updatePageNavigation();
      }

      // Check if we should auto-apply a template from URL params
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('template') && !signatureBoxes.length) {
        const templateName = urlParams.get('template');
        setTimeout(() => {
          applyTemplate(templateName);
        }, 500);
      }
    }

    async function renderPage(page, pageNum) {
      const scale = 1.5;
      const viewport = page.getViewport({ scale });

      // Create page card
      const pageCard = document.createElement('div');
      pageCard.className = 'page-card';
      pageCard.dataset.pageIndex = pageNum - 1;
      pageCard.id = `page-${pageNum - 1}`;

      // Page header
      const pageHeader = document.createElement('div');
      pageHeader.className = 'page-header';
      pageHeader.innerHTML = `
        <span class="page-number">Page ${pageNum}</span>
        <button class="btn small secondary" onclick="scrollToPage(${pageNum - 1})">Jump to Page</button>
      `;

      // Page wrapper
      const pageWrap = document.createElement('div');
      pageWrap.className = 'page-wrap';

      // Render canvas
      const canvas = document.createElement('canvas');
      canvas.className = 'render-canvas';
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      // Drawing canvas
      const drawCanvas = document.createElement('canvas');
      drawCanvas.className = 'draw-canvas';
      drawCanvas.width = viewport.width;
      drawCanvas.height = viewport.height;
      drawCanvas.style.position = 'absolute';
      drawCanvas.style.top = '0';
      drawCanvas.style.left = '0';
      drawCanvas.style.width = '100%';
      drawCanvas.style.height = '100%';

      // Signature boxes layer
      const boxesLayer = document.createElement('div');
      boxesLayer.className = 'signature-boxes-layer';
      boxesLayer.dataset.pageIndex = pageNum - 1;

      pageWrap.appendChild(canvas);
      pageWrap.appendChild(drawCanvas);
      pageWrap.appendChild(boxesLayer);
      
      pageCard.appendChild(pageHeader);
      pageCard.appendChild(pageWrap);
      pagesContainer.appendChild(pageCard);

      // Render PDF page
      const context = canvas.getContext('2d');
      await page.render({
        canvasContext: context,
        viewport: viewport
      }).promise;

      // Store page state
      pagesState.push({
        canvas: drawCanvas,
        context: drawCanvas.getContext('2d'),
        strokes: [],
        width: viewport.width,
        height: viewport.height,
        boxesLayer: boxesLayer
      });

      // Setup pen drawing
      setupPenDrawing(drawCanvas, pageNum - 1);

      // Add click handler for adding boxes
      boxesLayer.addEventListener('click', (e) => {
        if (currentMode !== 'box') return;
        if (e.target === boxesLayer) {
          const rect = boxesLayer.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          
          // Create appropriate box based on selected type
          switch(nextBoxType) {
            case 'date':
              addSignatureBox(pageNum - 1, x - 7, y - 3, 20, 8, 'Date', 'date');
              break;
            case 'initial':
              addSignatureBox(pageNum - 1, x - 5, y - 3, 15, 8, 'Initials', 'initial');
              break;
            case 'text':
              addSignatureBox(pageNum - 1, x - 10, y - 3, 30, 8, 'Text Field', 'text');
              break;
            case 'checkbox':
              addSignatureBox(pageNum - 1, x - 2, y - 2, 5, 5, 'Check', 'checkbox');
              break;
            case 'radio':
              const radioLabel = radioGroups.currentGroup || 'Option';
              addSignatureBox(pageNum - 1, x - 2, y - 2, 5, 5, radioLabel, 'radio');
              break;
            default: // signature
              addSignatureBox(pageNum - 1, x - 10, y - 5, 30, 10, 'Signature', 'signature');
          }
        }
      });
    }

    function setupPenDrawing(canvas, pageIndex) {
      const ctx = canvas.getContext('2d');
      let drawing = false;
      let lastX = 0;
      let lastY = 0;

      function startDrawing(e) {
        if (currentMode !== 'pen') return;
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = (e.clientX || e.touches[0].clientX) - rect.left;
        lastY = (e.clientY || e.touches[0].clientY) - rect.top;
        
        // Scale coordinates to canvas resolution
        lastX = (lastX / rect.width) * canvas.width;
        lastY = (lastY / rect.height) * canvas.height;

        // Start new stroke
        if (!pagesState[pageIndex].strokes[pagesState[pageIndex].strokes.length - 1]) {
          pagesState[pageIndex].strokes.push({
            color: penColor,
            width: penSize,
            points: []
          });
        }
      }

      function draw(e) {
        if (!drawing || currentMode !== 'pen') return;
        e.preventDefault();

        const rect = canvas.getBoundingClientRect();
        let currentX = (e.clientX || e.touches[0].clientX) - rect.left;
        let currentY = (e.clientY || e.touches[0].clientY) - rect.top;
        
        // Scale coordinates to canvas resolution
        currentX = (currentX / rect.width) * canvas.width;
        currentY = (currentY / rect.height) * canvas.height;

        ctx.strokeStyle = penColor;
        ctx.lineWidth = penSize * 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();

        // Store point
        const currentStroke = pagesState[pageIndex].strokes[pagesState[pageIndex].strokes.length - 1];
        if (currentStroke) {
          currentStroke.points.push({ x: currentX, y: currentY });
        }

        lastX = currentX;
        lastY = currentY;
      }

      function stopDrawing() {
        if (drawing && currentMode === 'pen') {
          // Finalize stroke
          pagesState[pageIndex].strokes.push(null); // Mark end of stroke
        }
        drawing = false;
      }

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Touch events
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrawing(e);
      });
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        draw(e);
      });
      canvas.addEventListener('touchend', stopDrawing);
    }


    function addSignatureBox(pageIndex, xPercent, yPercent, widthPercent = 30, heightPercent = 10, label = 'Sign Here', boxType = 'signature') {
      const boxesLayer = pagesState[pageIndex]?.boxesLayer;
      if (!boxesLayer) return;

      const box = document.createElement('div');
      box.className = 'signature-box';
      box.style.left = `${xPercent}%`;
      box.style.top = `${yPercent}%`;
      box.style.width = `${widthPercent}%`;
      box.style.height = `${heightPercent}%`;
      box.dataset.pageIndex = pageIndex;
      box.dataset.boxId = `box_${Date.now()}_${Math.random()}`;
      box.dataset.boxType = boxType;

      // Add visual distinction for different box types
      switch(boxType) {
        case 'date':
          box.style.borderColor = '#457b9d';
          box.style.background = 'rgba(69, 123, 157, 0.05)';
          break;
        case 'initial':
          box.style.borderColor = '#5a7a8c';
          box.style.background = 'rgba(90, 122, 140, 0.05)';
          break;
        case 'text':
          box.style.borderColor = '#6b46c1';
          box.style.background = 'rgba(107, 70, 193, 0.05)';
          break;
        case 'checkbox':
          box.style.borderColor = '#10b981';
          box.style.background = 'rgba(16, 185, 129, 0.05)';
          box.style.borderRadius = '4px';
          break;
        case 'radio':
          box.style.borderColor = '#f59e0b';
          box.style.background = 'rgba(245, 158, 11, 0.05)';
          box.style.borderRadius = '50%';
          break;
      }

      const boxLabel = document.createElement('div');
      boxLabel.className = 'signature-box-label';
      boxLabel.textContent = label;
      boxLabel.contentEditable = false;

      const hint = document.createElement('div');
      hint.className = 'signature-box-hint';
      
      // Set appropriate hint text
      switch(boxType) {
        case 'date':
          hint.textContent = 'Click to add date';
          break;
        case 'initial':
          hint.textContent = 'Click to initial';
          break;
        case 'text':
          hint.textContent = 'Click to type';
          break;
        case 'checkbox':
          hint.textContent = '‚òê';
          hint.style.fontSize = '20px';
          break;
        case 'radio':
          hint.textContent = '‚óã';
          hint.style.fontSize = '20px';
          break;
        default:
          hint.textContent = 'Click to sign';
      }

      // Add resize handles
      ['tl', 'tr', 'bl', 'br'].forEach(pos => {
        const handle = document.createElement('div');
        handle.className = `resize-handle ${pos}`;
        handle.addEventListener('mousedown', (e) => startResize(e, box, pos));
        handle.addEventListener('touchstart', (e) => startResize(e, box, pos));
        box.appendChild(handle);
      });

      // Add delete button
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-box-btn';
      deleteBtn.innerHTML = '√ó';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm('Delete this signature box?')) {
          box.remove();
          signatureBoxes = signatureBoxes.filter(b => b.element !== box);
          updateSaveTemplateButton();
        }
      };

      box.appendChild(boxLabel);
      box.appendChild(hint);
      box.appendChild(deleteBtn);
      boxesLayer.appendChild(box);

      // Make box draggable in box mode
      box.addEventListener('mousedown', (e) => {
        if (currentMode === 'box' && !e.target.classList.contains('resize-handle')) {
          startDrag(e, box);
        }
      });

      box.addEventListener('touchstart', (e) => {
        if (currentMode === 'box' && !e.target.classList.contains('resize-handle')) {
          startDrag(e, box);
        }
      });

      // Click handler for signing
      box.addEventListener('click', (e) => {
        if (currentMode === 'sign') {
          e.stopPropagation();
          if (!consent.given) {
            showModal('consentModal');
          } else {
            signBox(box);
          }
        } else if (currentMode === 'box') {
          e.stopPropagation();
          selectBox(box);
        }
      });

      // Double click to edit label in box mode
      boxLabel.addEventListener('dblclick', (e) => {
        if (currentMode === 'box') {
          e.stopPropagation();
          boxLabel.contentEditable = true;
          boxLabel.focus();
          
          // Select all text
          const range = document.createRange();
          range.selectNodeContents(boxLabel);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }
      });

      boxLabel.addEventListener('blur', () => {
        boxLabel.contentEditable = false;
      });

      boxLabel.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          boxLabel.contentEditable = false;
        }
      });

      // Store box info
      signatureBoxes.push({
        pageIndex,
        element: box,
        signed: false
      });

      if (currentMode === 'box') {
        showToast(`Added: ${label}`);
      }
      
      // Update save template button visibility
      updateSaveTemplateButton();
    }

    function selectBox(box) {
      // Deselect all boxes
      document.querySelectorAll('.signature-box').forEach(b => {
        b.classList.remove('selected');
      });
      
      // Select this box
      box.classList.add('selected');
      selectedBox = box;
    }

    function startDrag(e, box) {
      e.preventDefault();
      selectBox(box);
      
      const startX = e.clientX || e.touches[0].clientX;
      const startY = e.clientY || e.touches[0].clientY;
      const startLeft = parseFloat(box.style.left);
      const startTop = parseFloat(box.style.top);
      
      function drag(e) {
        const currentX = e.clientX || e.touches[0].clientX;
        const currentY = e.clientY || e.touches[0].clientY;
        
        const parent = box.parentElement;
        const parentRect = parent.getBoundingClientRect();
        
        const deltaX = ((currentX - startX) / parentRect.width) * 100;
        const deltaY = ((currentY - startY) / parentRect.height) * 100;
        
        box.style.left = `${Math.max(0, Math.min(90, startLeft + deltaX))}%`;
        box.style.top = `${Math.max(0, Math.min(90, startTop + deltaY))}%`;
      }
      
      function stopDrag() {
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('touchend', stopDrag);
      }
      
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', stopDrag);
    }

    function startResize(e, box, handle) {
      e.preventDefault();
      e.stopPropagation();
      
      const startX = e.clientX || e.touches[0].clientX;
      const startY = e.clientY || e.touches[0].clientY;
      const startWidth = parseFloat(box.style.width);
      const startHeight = parseFloat(box.style.height);
      const startLeft = parseFloat(box.style.left);
      const startTop = parseFloat(box.style.top);
      
      function resize(e) {
        const currentX = e.clientX || e.touches[0].clientX;
        const currentY = e.clientY || e.touches[0].clientY;
        
        const parent = box.parentElement;
        const parentRect = parent.getBoundingClientRect();
        
        const deltaX = ((currentX - startX) / parentRect.width) * 100;
        const deltaY = ((currentY - startY) / parentRect.height) * 100;
        
        if (handle.includes('r')) {
          box.style.width = `${Math.max(15, startWidth + deltaX)}%`;
        }
        if (handle.includes('l')) {
          const newWidth = Math.max(15, startWidth - deltaX);
          const newLeft = startLeft + (startWidth - newWidth);
          if (newLeft >= 0) {
            box.style.width = `${newWidth}%`;
            box.style.left = `${newLeft}%`;
          }
        }
        if (handle.includes('b')) {
          box.style.height = `${Math.max(8, startHeight + deltaY)}%`;
        }
        if (handle.includes('t')) {
          const newHeight = Math.max(8, startHeight - deltaY);
          const newTop = startTop + (startHeight - newHeight);
          if (newTop >= 0) {
            box.style.height = `${newHeight}%`;
            box.style.top = `${newTop}%`;
          }
        }
      }
      
      function stopResize() {
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('mouseup', stopResize);
        document.removeEventListener('touchmove', resize);
        document.removeEventListener('touchend', stopResize);
      }
      
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
      document.addEventListener('touchmove', resize);
      document.addEventListener('touchend', stopResize);
    }

    function signBox(box) {
      const boxType = box.dataset.boxType;
      
      // Handle checkbox toggle
      if (boxType === 'checkbox') {
        if (box.classList.contains('signed')) {
          box.classList.remove('signed');
          const hint = box.querySelector('.signature-box-hint');
          hint.textContent = '‚òê';
          showToast('Checkbox unchecked');
        } else {
          box.classList.add('signed');
          const hint = box.querySelector('.signature-box-hint');
          hint.textContent = '‚òë';
          showToast('Checkbox checked');
        }
        return;
      }
      
      // Handle radio button selection
      if (boxType === 'radio') {
        const groupName = box.querySelector('.signature-box-label').textContent;
        // Uncheck other radio buttons in the same group on the same page
        const pageIndex = parseInt(box.dataset.pageIndex);
        document.querySelectorAll(`.signature-box[data-box-type="radio"][data-page-index="${pageIndex}"]`).forEach(radio => {
          const radioLabel = radio.querySelector('.signature-box-label').textContent;
          if (radioLabel === groupName || radioLabel.startsWith(groupName.split(' ')[0])) {
            radio.classList.remove('signed');
            radio.querySelector('.signature-box-hint').textContent = '‚óã';
          }
        });
        box.classList.add('signed');
        box.querySelector('.signature-box-hint').textContent = '‚óè';
        showToast(`Selected: ${groupName}`);
        return;
      }
      
      // Handle text input
      if (boxType === 'text') {
        const currentText = box.dataset.textContent || '';
        const newText = prompt('Enter text:', currentText);
        if (newText !== null) {
          box.dataset.textContent = newText;
          box.classList.add('signed');
          const hint = box.querySelector('.signature-box-hint');
          hint.textContent = newText || 'Click to type';
          hint.style.fontSize = '12px';
          hint.style.fontWeight = 'normal';
          showToast('Text added');
        }
        return;
      }
      
      // Regular signature/initial/date boxes - draw on canvas
      box.classList.add('signed');
      const pageIndex = parseInt(box.dataset.pageIndex);
      const canvas = pagesState[pageIndex].canvas;
      const ctx = canvas.getContext('2d');
      
      const rect = box.getBoundingClientRect();
      const canvasRect = canvas.getBoundingClientRect();
      
      const x = ((rect.left - canvasRect.left) / canvasRect.width) * canvas.width;
      const y = ((rect.top - canvasRect.top) / canvasRect.height) * canvas.height;
      const width = (rect.width / canvasRect.width) * canvas.width;
      const height = (rect.height / canvasRect.height) * canvas.height;

      // Clear the box area first
      ctx.save();
      
      // Set clipping region to box area
      ctx.beginPath();
      ctx.rect(x, y, width, height);
      ctx.clip();
      
      // Clear the area
      ctx.clearRect(x, y, width, height);

      // Calculate appropriate font size based on box dimensions
      const fontSize = Math.max(Math.min(height * 0.5, width * 0.1, 50), 20);
      
      if (boxType === 'date') {
        // Draw date
        const today = new Date();
        const dateStr = `${today.getMonth()+1}/${today.getDate()}/${today.getFullYear()}`;
        
        ctx.font = `bold ${fontSize * 0.9}px Arial, sans-serif`;
        ctx.fillStyle = '#0b1d29';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(dateStr, x + width/2, y + height/2);
      } else if (boxType === 'initial') {
        // Draw initials
        const names = consent.name.split(' ');
        const initials = names.map(n => n[0]).join('').toUpperCase();
        
        ctx.fillStyle = '#0b1d29';
        ctx.strokeStyle = '#0b1d29';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // Use a simple bold font for initials
        ctx.font = `bold ${fontSize * 1.2}px Arial, sans-serif`;
        
        // Draw the initials
        ctx.fillText(initials, x + width/2, y + height/2);
        
        // No underline for initials
        showToast('Initials added');
      } else {
        // Draw full signature
        // Ensure text is always visible with good contrast
        ctx.fillStyle = '#0b1d29';
        ctx.strokeStyle = '#0b1d29';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // Use a simple bold italic font that's guaranteed to work
        ctx.font = `italic bold ${fontSize}px Arial, sans-serif`;
        
        // Add slight shadow for better visibility
        ctx.shadowColor = 'rgba(0,0,0,0.1)';
        ctx.shadowBlur = 1;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 1;
        
        // Draw the name clearly
        const displayName = consent.name;
        ctx.fillText(displayName, x + width/2, y + height/2);
        
        // Remove shadow for underline
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        
        // Draw a strong underline for signature emphasis
        ctx.strokeStyle = '#0b1d29';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x + width * 0.15, y + height * 0.75);
        ctx.lineTo(x + width * 0.85, y + height * 0.75);
        ctx.stroke();
      }
      
      // Reset context
      ctx.restore();
      ctx.textAlign = 'start';
      ctx.textBaseline = 'alphabetic';

      // Mark the signature box info as signed
      const boxInfo = signatureBoxes.find(b => b.element === box);
      if (boxInfo) {
        boxInfo.signed = true;
      }

      showToast(boxType === 'date' ? 'Date added' : 'Signature added');
    }

    // Page navigation
    function updatePageNavigation() {
      pageIndicator.textContent = `${currentPageIndex + 1}/${pdfDoc.numPages}`;
      btnPrevPage.disabled = currentPageIndex === 0;
      btnNextPage.disabled = currentPageIndex === pdfDoc.numPages - 1;
    }

    function scrollToPage(pageIndex) {
      const pageElement = document.getElementById(`page-${pageIndex}`);
      if (pageElement) {
        pageElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        currentPageIndex = pageIndex;
        updatePageNavigation();
      }
    }

    btnPrevPage.addEventListener('click', () => {
      if (currentPageIndex > 0) {
        scrollToPage(currentPageIndex - 1);
      }
    });

    btnNextPage.addEventListener('click', () => {
      if (currentPageIndex < pdfDoc.numPages - 1) {
        scrollToPage(currentPageIndex + 1);
      }
    });

    // Clear functionality
    btnClear.addEventListener('click', () => {
      if (!confirm('Clear all drawings and signatures?')) return;
      
      pagesState.forEach(state => {
        const ctx = state.context;
        ctx.clearRect(0, 0, state.width, state.height);
        state.strokes = [];
      });

      document.querySelectorAll('.signature-box').forEach(box => {
        box.classList.remove('signed');
      });

      showToast('All cleared');
    });

    // Undo functionality
    btnUndo.addEventListener('click', () => {
      // Simple undo for last stroke
      pagesState.forEach(state => {
        if (state.strokes.length > 0) {
          state.strokes.pop();
          // Redraw
          const ctx = state.context;
          ctx.clearRect(0, 0, state.width, state.height);
          
          state.strokes.forEach(stroke => {
            if (!stroke) return;
            
            ctx.strokeStyle = stroke.color;
            ctx.lineWidth = stroke.width * 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            stroke.points.forEach((point, i) => {
              if (i === 0) {
                ctx.moveTo(point.x, point.y);
              } else {
                ctx.lineTo(point.x, point.y);
              }
            });
            ctx.stroke();
          });
        }
      });
      
      showToast('Undo last action');
    });

    // Consent handling
    consentCheck.addEventListener('change', () => {
      btnConsent.disabled = !consentCheck.checked || !signerName.value.trim();
    });

    signerName.addEventListener('input', () => {
      btnConsent.disabled = !consentCheck.checked || !signerName.value.trim();
    });

    btnConsent.addEventListener('click', () => {
      if (!signerName.value.trim()) {
        showToast('Please enter your name');
        return;
      }

      consent.given = true;
      consent.name = signerName.value.trim();
      consent.policy = policyNumber.value.trim();
      consent.phone = phoneNumber.value.trim();
      consent.timestamp = new Date().toISOString();
      
      // Generate confirmation ID when consent is given
      if (!confirmationId) {
        confirmationId = generateConfirmationId();
      }

      consentStatus.textContent = `Signed by ${consent.name}`;
      consentStatus.className = 'status-chip success';

      hideModal('consentModal');
      showToast('Consent recorded - You can now sign');
    });

    // Save functionality
    fabSave.addEventListener('click', () => {
      if (!currentPdfBytes) {
        showToast('No PDF loaded');
        return;
      }

      showModal('downloadModal');
    });

    // Print functionality
    fabPrint.addEventListener('click', async () => {
      if (!currentPdfBytes) {
        showToast('No PDF loaded');
        return;
      }

      try {
        console.log('Starting print process...');
        showToast('Preparing document for print...');
        
        const signedPdf = await buildSignedPdf();
        const auditPdf = await generateAuditPdf();
        
        let finalPdf = signedPdf;
        if (auditPdf) {
          const combinedPdf = await combinePdfs(signedPdf, auditPdf);
          if (combinedPdf) {
            finalPdf = combinedPdf;
          }
        }
        
        const blob = new Blob([finalPdf], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Open in new window for printing
        const printWindow = window.open(url, '_blank');
        if (printWindow) {
          printWindow.onload = function() {
            setTimeout(() => {
              try {
                printWindow.print();
              } catch (e) {
                console.error('Print command failed:', e);
              }
            }, 500);
          };
        }
        
        showToast('Document opened for printing');
      } catch (err) {
        console.error('Print process failed:', err);
        showToast(`Print failed: ${err.message}`);
      }
    });

    // Quick download functionality
    fabDownload.addEventListener('click', async () => {
      if (!currentPdfBytes) {
        showToast('No PDF loaded');
        return;
      }

      try {
        showToast('Preparing download...');
        const signedPdf = await buildSignedPdf();
        
        // Generate audit trail PDF
        const auditPdf = await generateAuditPdf();
        
        // Combine signed PDF with audit trail
        let finalPdf = signedPdf;
        if (auditPdf) {
          const combinedPdf = await combinePdfs(signedPdf, auditPdf);
          if (combinedPdf) {
            finalPdf = combinedPdf;
          }
        }
        
        const fileName = generateFileName();
        
        // Download combined PDF (includes audit trail)
        downloadBlob(fileName, finalPdf, 'application/pdf');
        
        // Also download confirmation page
        const confirmation = generateConfirmationHtml();
        downloadBlob(
          fileName.replace('.pdf', '_confirmation.html'),
          new TextEncoder().encode(confirmation),
          'text/html'
        );
        
        showToast('Files downloaded with audit trail!');
      } catch (err) {
        showToast('Download failed');
        console.error(err);
      }
    });

    // Download handling
    btnDownloadLocal.addEventListener('click', async () => {
      try {
        const signedPdf = await buildSignedPdf();
        const fileName = generateFileName();
        
        // Check if audit should be included with the main PDF
        let finalPdf = signedPdf;
        if (el('downloadAudit').checked) {
          const auditPdf = await generateAuditPdf();
          if (auditPdf) {
            // Combine signed PDF with audit trail
            const combinedPdf = await combinePdfs(signedPdf, auditPdf);
            if (combinedPdf) {
              finalPdf = combinedPdf;
              showToast('Audit trail included in PDF');
            } else {
              // If combine fails, download separately
              downloadBlob(
                fileName.replace('.pdf', '_audit.pdf'),
                auditPdf,
                'application/pdf'
              );
            }
          }
        }
        
        // Download the final PDF (with or without audit)
        downloadBlob(fileName, finalPdf, 'application/pdf');

        // Download confirmation if selected
        if (el('downloadConfirmation').checked) {
          const confirmation = generateConfirmationHtml();
          downloadBlob(
            fileName.replace('.pdf', '_confirmation.html'),
            new TextEncoder().encode(confirmation),
            'text/html'
          );
        }

        showToast('Files downloaded successfully');
        hideModal('downloadModal');
      } catch (err) {
        showToast('Download failed');
        console.error(err);
      }
    });

    async function buildSignedPdf() {
      console.log('buildSignedPdf: Starting...');
      
      try {
        if (!currentPdfBytes || currentPdfBytes.length === 0) {
          throw new Error('No PDF bytes available');
        }
        
        // Load the PDF
        const pdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes, {
          ignoreEncryption: true,
          throwOnInvalidObject: false
        });
        
        // Generate confirmation ID if not already generated
        if (!confirmationId) {
          confirmationId = generateConfirmationId();
        }
        
        // Set metadata
        pdfDoc.setTitle('Signed Document - Bill Layne Insurance');
        if (consent.name) {
          pdfDoc.setAuthor(consent.name);
        }
        pdfDoc.setSubject('Electronically Signed Document');
        pdfDoc.setCreationDate(new Date());
        pdfDoc.setModificationDate(new Date());
        
        // Embed fonts
        const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const helveticaBoldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
        
        // Embed drawings and signatures
        for (let i = 0; i < pagesState.length; i++) {
          const state = pagesState[i];
          const canvas = state.canvas;
          
          // Check if canvas has any content
          const ctx = canvas.getContext('2d');
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const pixels = imageData.data;
          let hasContent = false;
          
          for (let j = 3; j < pixels.length; j += 4) {
            if (pixels[j] > 0) {
              hasContent = true;
              break;
            }
          }
          
          if (!hasContent) continue;
          
          try {
            const blob = await new Promise((resolve, reject) => {
              canvas.toBlob((blob) => {
                if (blob) {
                  resolve(blob);
                } else {
                  const dataUrl = canvas.toDataURL('image/png');
                  fetch(dataUrl)
                    .then(res => res.blob())
                    .then(resolve)
                    .catch(reject);
                }
              }, 'image/png', 1.0);
            });
            
            const arrayBuffer = await blob.arrayBuffer();
            
            if (arrayBuffer.byteLength === 0) continue;
            
            const pngImage = await pdfDoc.embedPng(arrayBuffer);
            const page = pdfDoc.getPage(i);
            const { width, height } = page.getSize();
            
            page.drawImage(pngImage, {
              x: 0,
              y: 0,
              width: width,
              height: height,
              opacity: 1
            });
          } catch (imgError) {
            console.error(`Failed to process page ${i + 1}:`, imgError);
          }
        }
        
        // Add footer to all pages
        const pages = pdfDoc.getPages();
        const footerText = `Confirmation ID: ${confirmationId}`;
        const signedDate = new Date().toLocaleString();
        
        for (let i = 0; i < pages.length; i++) {
          const page = pages[i];
          const { width, height } = page.getSize();
          
          // Draw footer background
          page.drawRectangle({
            x: 0,
            y: 0,
            width: width,
            height: 25,
            color: PDFLib.rgb(0.95, 0.95, 0.95),
            opacity: 0.9
          });
          
          // Add confirmation ID
          page.drawText(footerText, {
            x: 10,
            y: 8,
            size: 9,
            font: helveticaBoldFont,
            color: PDFLib.rgb(0.1, 0.37, 0.48)
          });
          
          // Add page number
          page.drawText(`Page ${i + 1} of ${pages.length}`, {
            x: width / 2 - 30,
            y: 8,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3)
          });
          
          // Add signed date
          page.drawText(`Signed: ${signedDate}`, {
            x: width - 150,
            y: 8,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3)
          });
        }
        
        return await pdfDoc.save();
      } catch (error) {
        console.error('buildSignedPdf: Fatal error:', error);
        return currentPdfBytes;
      }
    }

    function generateFileName() {
      const date = new Date();
      const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
      
      if (consent.name) {
        const name = consent.name.replace(/\s+/g, '_');
        const policy = consent.policy ? `_${consent.policy}` : '';
        return `${name}_signed_${dateStr}${policy}.pdf`;
      } else {
        return `signed_document_${dateStr}.pdf`;
      }
    }

    function generateConfirmationHtml() {
      return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Signature Confirmation - Bill Layne Insurance</title>
  <style>
    body { font-family: 'Plus Jakarta Sans', Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #1a5f7a, #457b9d); color: white; padding: 30px; border-radius: 10px; text-align: center; }
    .logo { max-width: 200px; margin-bottom: 20px; }
    .content { background: #f8f9fa; padding: 30px; margin-top: 20px; border-radius: 10px; }
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd; }
    .signature { margin-top: 30px; padding: 20px; background: white; border: 2px solid #1a5f7a; border-radius: 10px; }
    .footer { text-align: center; margin-top: 40px; color: #666; }
    @media print { body { margin: 0; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>Electronic Signature Confirmation</h1>
    <p>Bill Layne Insurance Agency</p>
  </div>
  
  <div class="content">
    <h2>Document Successfully Signed</h2>
    
    <div class="info-row">
      <strong>Confirmation ID:</strong>
      <span style="font-weight: bold; color: #1a5f7a;">${confirmationId}</span>
    </div>
    
    <div class="info-row">
      <strong>Signer Name:</strong>
      <span>${consent.name}</span>
    </div>
    
    <div class="info-row">
      <strong>Policy Number:</strong>
      <span>${consent.policy || 'N/A'}</span>
    </div>
    
    <div class="info-row">
      <strong>Phone Number:</strong>
      <span>${consent.phone || 'N/A'}</span>
    </div>
    
    <div class="info-row">
      <strong>Date & Time:</strong>
      <span>${new Date(consent.timestamp).toLocaleString()}</span>
    </div>
    
    <div class="info-row">
      <strong>Document Pages:</strong>
      <span>${pagesState.length}</span>
    </div>
    
    <div class="info-row">
      <strong>Signature Boxes Completed:</strong>
      <span>${signatureBoxes.filter(b => b.element.classList.contains('signed')).length} of ${signatureBoxes.length}</span>
    </div>
    
    <div class="signature">
      <h3>Electronic Signature Certification</h3>
      <p>This document has been electronically signed in accordance with the Electronic Signatures in Global and National Commerce Act (ESIGN) and the Uniform Electronic Transactions Act (UETA).</p>
      <p><strong>Document Hash:</strong> ${Math.random().toString(36).substr(2, 9).toUpperCase()}</p>
      <p><strong>Device:</strong> ${navigator.userAgent}</p>
    </div>
  </div>
  
  <div class="footer">
    <p><strong>Bill Layne Insurance Agency</strong></p>
    <p>1283 N Bridge St, Elkin NC 28621</p>
    <p>Phone: (336) 835-1993 | Email: Save@BillLayneInsurance.com</p>
    <p>www.BillLayneInsurance.com</p>
  </div>
</body>
</html>`;
    }

    async function combinePdfs(pdf1Bytes, pdf2Bytes) {
      try {
        const pdf1 = await PDFLib.PDFDocument.load(pdf1Bytes);
        const pdf2 = await PDFLib.PDFDocument.load(pdf2Bytes);
        
        const mergedPdf = await PDFLib.PDFDocument.create();
        
        // Copy all pages from first PDF
        const pages1 = await mergedPdf.copyPages(pdf1, pdf1.getPageIndices());
        pages1.forEach(page => mergedPdf.addPage(page));
        
        // Copy all pages from second PDF
        const pages2 = await mergedPdf.copyPages(pdf2, pdf2.getPageIndices());
        pages2.forEach(page => mergedPdf.addPage(page));
        
        return await mergedPdf.save();
      } catch (error) {
        console.error('Failed to combine PDFs:', error);
        return null;
      }
    }

    async function generateAuditPdf() {
      try {
        if (!confirmationId) {
          confirmationId = generateConfirmationId();
        }
        
        const auditDoc = await PDFLib.PDFDocument.create();
        const page = auditDoc.addPage([612, 792]); // Letter size
        
        const helveticaFont = await auditDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const helveticaBoldFont = await auditDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
        const timesFont = await auditDoc.embedFont(PDFLib.StandardFonts.TimesRoman);
        
        const { width, height } = page.getSize();
        let yPosition = height - 50;
        
        // Header
        page.drawRectangle({
          x: 0,
          y: height - 80,
          width: width,
          height: 80,
          color: PDFLib.rgb(0.1, 0.37, 0.48)
        });
        
        page.drawText('ELECTRONIC SIGNATURE AUDIT TRAIL', {
          x: 50,
          y: height - 45,
          size: 18,
          font: helveticaBoldFont,
          color: PDFLib.rgb(1, 1, 1)
        });
        
        page.drawText('Bill Layne Insurance Agency', {
          x: 50,
          y: height - 65,
          size: 12,
          font: helveticaFont,
          color: PDFLib.rgb(1, 1, 1)
        });
        
        yPosition = height - 110;
        
        // Confirmation ID
        page.drawRectangle({
          x: 40,
          y: yPosition - 30,
          width: width - 80,
          height: 40,
          borderColor: PDFLib.rgb(0.1, 0.37, 0.48),
          borderWidth: 1
        });
        
        page.drawText(`CONFIRMATION ID: ${confirmationId}`, {
          x: 50,
          y: yPosition - 10,
          size: 14,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.1, 0.37, 0.48)
        });
        
        yPosition -= 60;
        
        // Document Information
        page.drawText('DOCUMENT INFORMATION', {
          x: 50,
          y: yPosition,
          size: 12,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0, 0, 0)
        });
        
        yPosition -= 25;
        const signedCount = signatureBoxes.filter(b => b.element.classList.contains('signed')).length;
        const penStrokes = pagesState.reduce((sum, state) => sum + state.strokes.filter(s => s).length, 0);
        
        const docInfo = [
          `Document Pages: ${pagesState.length}`,
          `Signature Fields: ${signatureBoxes.length}`,
          `Signatures Completed: ${signedCount}`,
          `Pen Strokes Added: ${penStrokes}`,
          `Date Signed: ${new Date(consent.timestamp).toLocaleString()}`
        ];
        
        docInfo.forEach(info => {
          page.drawText(info, {
            x: 70,
            y: yPosition,
            size: 10,
            font: helveticaFont,
            color: PDFLib.rgb(0.2, 0.2, 0.2)
          });
          yPosition -= 18;
        });
        
        yPosition -= 10;
        
        // Signer Information
        page.drawText('SIGNER INFORMATION', {
          x: 50,
          y: yPosition,
          size: 12,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0, 0, 0)
        });
        
        yPosition -= 25;
        const signerInfo = [
          `Name: ${consent.name}`,
          `Policy Number: ${consent.policy || 'N/A'}`,
          `Phone Number: ${consent.phone || 'N/A'}`,
          `Consent Given: ${consent.given ? 'Yes' : 'No'}`,
          `Consent Timestamp: ${new Date(consent.timestamp).toISOString()}`
        ];
        
        signerInfo.forEach(info => {
          page.drawText(info, {
            x: 70,
            y: yPosition,
            size: 10,
            font: helveticaFont,
            color: PDFLib.rgb(0.2, 0.2, 0.2)
          });
          yPosition -= 18;
        });
        
        // Footer
        page.drawRectangle({
          x: 0,
          y: 0,
          width: width,
          height: 60,
          color: PDFLib.rgb(0.95, 0.95, 0.95)
        });
        
        page.drawText('Bill Layne Insurance Agency | 1283 N Bridge St, Elkin NC 28621 | (336) 835-1993', {
          x: 50,
          y: 10,
          size: 8,
          font: helveticaFont,
          color: PDFLib.rgb(0.4, 0.4, 0.4)
        });
        
        auditDoc.setTitle('Electronic Signature Audit Trail');
        auditDoc.setAuthor('Bill Layne Insurance Agency');
        auditDoc.setSubject(`Audit Trail for Confirmation ID: ${confirmationId}`);
        auditDoc.setCreationDate(new Date());
        
        return await auditDoc.save();
      } catch (error) {
        console.error('Failed to generate audit PDF:', error);
        return null;
      }
    }

    function downloadBlob(filename, data, mimeType) {
      const blob = new Blob([data], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Load custom templates from localStorage
    function loadCustomTemplates() {
      const stored = localStorage.getItem('customTemplates');
      return stored ? JSON.parse(stored) : {};
    }

    // Save custom templates to localStorage
    function saveCustomTemplates(templates) {
      localStorage.setItem('customTemplates', JSON.stringify(templates));
      updateTemplateSelector();
    }

    // Combine built-in and custom templates
    let customTemplates = loadCustomTemplates();
    
    // Templates for common insurance forms (built-in) - EXPANDED VERSION
    const builtInTemplates = {
      // Auto Insurance Templates
      'nc_grange_auto': {
        name: 'NC Grange Auto Application',
        boxes: [
          { page: 0, x: 10, y: 70, width: 35, height: 10, label: 'Applicant Signature', type: 'signature' },
          { page: 0, x: 55, y: 70, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 85, width: 35, height: 10, label: 'Co-Applicant Signature', type: 'signature' },
          { page: 0, x: 55, y: 85, width: 20, height: 8, label: 'Date', type: 'date' }
        ]
      },
      'progressive_auto': {
        name: 'Progressive Auto Application',
        boxes: [
          { page: 0, x: 10, y: 75, width: 35, height: 10, label: 'Named Insured', type: 'signature' },
          { page: 0, x: 55, y: 75, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 88, width: 15, height: 8, label: 'Initials', type: 'initial' }
        ]
      },
      'national_gen_auto': {
        name: 'National General Auto Application',
        boxes: [
          { page: 0, x: 10, y: 72, width: 35, height: 10, label: 'Policyholder Signature', type: 'signature' },
          { page: 0, x: 55, y: 72, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 60, width: 5, height: 5, label: 'Electronic Consent', type: 'checkbox' }
        ]
      },
      
      // Home Insurance Templates  
      'nationwide_home': {
        name: 'Nationwide Home Application',
        boxes: [
          { page: 0, x: 10, y: 68, width: 35, height: 10, label: 'Owner Signature', type: 'signature' },
          { page: 0, x: 55, y: 68, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 82, width: 35, height: 10, label: 'Co-Owner Signature', type: 'signature' },
          { page: 0, x: 55, y: 82, width: 20, height: 8, label: 'Date', type: 'date' }
        ]
      },
      'travelers_home': {
        name: 'Travelers Home Application',
        boxes: [
          { page: 0, x: 10, y: 70, width: 35, height: 10, label: 'Homeowner Signature', type: 'signature' },
          { page: 0, x: 55, y: 70, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 55, width: 15, height: 8, label: 'Initials', type: 'initial' }
        ]
      },
      
      // Specialty Insurance Templates
      'foremost_mobile': {
        name: 'Foremost Mobile Home Application',
        boxes: [
          { page: 0, x: 10, y: 65, width: 35, height: 10, label: 'Primary Resident', type: 'signature' },
          { page: 0, x: 55, y: 65, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 80, width: 35, height: 10, label: 'Co-Resident', type: 'signature' },
          { page: 0, x: 55, y: 80, width: 20, height: 8, label: 'Date', type: 'date' }
        ]
      },
      'alamance_farm': {
        name: 'Alamance Farm/Ranch Application',
        boxes: [
          { page: 0, x: 10, y: 70, width: 35, height: 10, label: 'Farm Owner', type: 'signature' },
          { page: 0, x: 55, y: 70, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 85, width: 35, height: 10, label: 'Spouse/Co-Owner', type: 'signature' },
          { page: 0, x: 55, y: 85, width: 20, height: 8, label: 'Date', type: 'date' }
        ]
      },
      
      // Claims and General Forms
      'auto_claim': {
        name: 'Auto Insurance Claim',
        boxes: [
          { page: 0, x: 10, y: 60, width: 35, height: 10, label: 'Claimant Signature', type: 'signature' },
          { page: 0, x: 55, y: 60, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 75, width: 15, height: 8, label: 'Initials', type: 'initial' }
        ]
      },
      'home_claim': {
        name: 'Home Insurance Claim',
        boxes: [
          { page: 0, x: 10, y: 65, width: 35, height: 10, label: 'Property Owner', type: 'signature' },
          { page: 0, x: 55, y: 65, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 80, width: 5, height: 5, label: 'Emergency Repairs', type: 'checkbox' },
          { page: 0, x: 20, y: 80, width: 5, height: 5, label: 'Temporary Housing', type: 'checkbox' }
        ]
      },
      'home_insurance': {
        name: 'Home Insurance Application',
        boxes: [
          { page: 0, x: 10, y: 80, width: 35, height: 10, label: 'Applicant Signature', type: 'signature' },
          { page: 0, x: 55, y: 80, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 50, width: 5, height: 5, label: 'Coverage A', type: 'checkbox' },
          { page: 0, x: 10, y: 56, width: 5, height: 5, label: 'Coverage B', type: 'checkbox' }
        ]
      },
      'consent_form': {
        name: 'General Consent Form',
        boxes: [
          { page: 0, x: 10, y: 85, width: 35, height: 10, label: 'Signature', type: 'signature' },
          { page: 0, x: 55, y: 85, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 70, width: 30, height: 8, label: 'Printed Name', type: 'text' }
        ]
      },
      'no_loss': {
        name: 'No Loss Letter',
        boxes: [
          { page: 0, x: 10, y: 75, width: 35, height: 10, label: 'Insured Signature', type: 'signature' },
          { page: 0, x: 55, y: 75, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 60, width: 5, height: 5, label: 'No Claims', type: 'checkbox' },
          { page: 0, x: 20, y: 60, width: 5, height: 5, label: 'No Losses', type: 'checkbox' }
        ]
      },
      'cancellation': {
        name: 'Policy Cancellation Request',
        boxes: [
          { page: 0, x: 10, y: 70, width: 35, height: 10, label: 'Policyholder Signature', type: 'signature' },
          { page: 0, x: 55, y: 70, width: 20, height: 8, label: 'Date', type: 'date' },
          { page: 0, x: 10, y: 85, width: 30, height: 8, label: 'Reason for Cancellation', type: 'text' }
        ]
      }
    };
    
    // Merge all templates
    const formTemplates = { ...builtInTemplates, ...customTemplates };

    // Apply template
    function applyTemplate(templateName) {
      // Check both built-in and custom templates
      const allTemplates = { ...builtInTemplates, ...customTemplates };
      const template = allTemplates[templateName];
      if (!template || !pagesState.length) return;
      
      template.boxes.forEach(boxConfig => {
        if (boxConfig.page < pagesState.length) {
          addSignatureBox(
            boxConfig.page,
            boxConfig.x,
            boxConfig.y,
            boxConfig.width,
            boxConfig.height,
            boxConfig.label,
            boxConfig.type
          );
        }
      });
      
      showToast(`Template applied: ${template.name}`);
    }

    // Save current boxes as template
    function saveCurrentAsTemplate() {
      const templateName = document.getElementById('newTemplateName').value.trim();
      if (!templateName) {
        showToast('Please enter a template name');
        return;
      }
      
      if (!signatureBoxes.length) {
        showToast('No signature boxes to save');
        return;
      }
      
      // Capture current box positions
      const boxes = [];
      signatureBoxes.forEach(boxInfo => {
        const box = boxInfo.element;
        const pageIndex = parseInt(box.dataset.pageIndex);
        const label = box.querySelector('.signature-box-label').textContent;
        const boxType = box.dataset.boxType;
        
        // Get position as percentages
        const x = parseFloat(box.style.left);
        const y = parseFloat(box.style.top);
        const width = parseFloat(box.style.width);
        const height = parseFloat(box.style.height);
        
        boxes.push({
          page: pageIndex,
          x: x,
          y: y,
          width: width,
          height: height,
          label: label,
          type: boxType
        });
      });
      
      // Create template ID from name
      const templateId = templateName.toLowerCase().replace(/\s+/g, '_');
      
      // Save to custom templates
      customTemplates[templateId] = {
        name: templateName,
        boxes: boxes,
        createdAt: new Date().toISOString()
      };
      
      saveCustomTemplates(customTemplates);
      updateTemplatesList();
      document.getElementById('newTemplateName').value = '';
      showToast(`Template "${templateName}" saved successfully!`);
      hideModal('templateModal');
    }

    // Update template selector dropdown
    function updateTemplateSelector() {
      const selector = document.getElementById('templateSelector');
      
      // Keep the optgroups structure but add custom templates
      const customOptions = Object.entries(customTemplates).map(([id, template]) => 
        `<option value="${id}">üìå ${template.name}</option>`
      ).join('');
      
      if (customOptions) {
        // Find the divider and insert custom templates before it
        const optgroupEnd = '</optgroup>';
        const lastOptgroupEnd = selector.innerHTML.lastIndexOf(optgroupEnd);
        
        if (lastOptgroupEnd > -1) {
          selector.innerHTML = 
            selector.innerHTML.slice(0, lastOptgroupEnd + optgroupEnd.length) +
            '<optgroup label="Custom Templates">' +
            customOptions +
            '</optgroup>' +
            selector.innerHTML.slice(lastOptgroupEnd + optgroupEnd.length);
        }
      }
    }

    // Update templates list in modal
    function updateTemplatesList() {
      const listContainer = document.getElementById('customTemplatesList');
      
      if (Object.keys(customTemplates).length === 0) {
        listContainer.innerHTML = '<p style="color: #666; font-style: italic;">No custom templates yet</p>';
        return;
      }
      
      listContainer.innerHTML = '';
      Object.entries(customTemplates).forEach(([id, template]) => {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 8px;';
        item.innerHTML = `
          <div>
            <strong>${template.name}</strong>
            <small style="display: block; color: #666;">${template.boxes.length} boxes</small>
          </div>
          <div style="display: flex; gap: 5px;">
            <button class="btn small secondary" onclick="applyTemplate('${id}')">Apply</button>
            <button class="btn small danger" onclick="deleteTemplate('${id}')">Delete</button>
          </div>
        `;
        listContainer.appendChild(item);
      });
    }

    // Delete template
    function deleteTemplate(templateId) {
      if (confirm(`Delete template "${customTemplates[templateId].name}"?`)) {
        delete customTemplates[templateId];
        saveCustomTemplates(customTemplates);
        updateTemplatesList();
        showToast('Template deleted');
      }
    }

    // Export templates
    function exportTemplates() {
      const dataStr = JSON.stringify(customTemplates, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'signature-templates.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Templates exported');
    }

    // Import templates
    function importTemplates(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          
          // Merge with existing templates
          Object.entries(imported).forEach(([id, template]) => {
            customTemplates[id] = template;
          });
          
          saveCustomTemplates(customTemplates);
          updateTemplatesList();
          showToast('Templates imported successfully');
        } catch (err) {
          showToast('Failed to import templates');
          console.error(err);
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // Reset input
    }

    // Parse URL parameters
    function parseUrlParams() {
      const params = new URLSearchParams(window.location.search);
      
      // Pre-fill name
      if (params.has('name')) {
        signerName.value = decodeURIComponent(params.get('name'));
      }
      
      // Pre-fill policy number
      if (params.has('policy')) {
        policyNumber.value = decodeURIComponent(params.get('policy'));
      }
      
      // Pre-fill phone number
      if (params.has('phone')) {
        phoneNumber.value = decodeURIComponent(params.get('phone'));
      }
      
      // Auto-load template
      if (params.has('template')) {
        const templateName = params.get('template');
        // Store for later application after PDF loads
        window.pendingTemplate = templateName;
      }
      
      // Auto-open file dialog
      if (params.has('autoload')) {
        setTimeout(() => {
          fileInput.click();
        }, 500);
      }
    }

    // PWA Install Support
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      if (!document.getElementById('installBtn')) {
        const installBtn = document.createElement('button');
        installBtn.id = 'installBtn';
        installBtn.className = 'btn success small';
        installBtn.innerHTML = 'üì± Install App';
        installBtn.style.marginLeft = 'auto';
        installBtn.onclick = async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              showToast('App installed successfully!');
            }
            deferredPrompt = null;
            installBtn.style.display = 'none';
          }
        };
        document.querySelector('.toolbar').appendChild(installBtn);
      }
    });
    
    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed'));
    }
    
    // Handle app installed
    window.addEventListener('appinstalled', () => {
      showToast('App installed! You can now use it offline.');
      const installBtn = document.getElementById('installBtn');
      if (installBtn) installBtn.style.display = 'none';
    });

    // Show/hide save template button based on boxes
    function updateSaveTemplateButton() {
      const btn = document.getElementById('btnSaveTemplate');
      if (signatureBoxes.length > 0) {
        btn.style.display = 'inline-flex';
      } else {
        btn.style.display = 'none';
      }
    }
    
    // Add event listener for save template button
    document.getElementById('btnSaveTemplate').addEventListener('click', () => {
      showModal('templateModal');
      updateTemplatesList();
    });

    // Initialize
    window.addEventListener('load', () => {
      setMode('pen');
      parseUrlParams();
      updateTemplateSelector(); // Load custom templates into dropdown
      
      // Show install prompt if not installed
      if (window.matchMedia('(display-mode: browser)').matches) {
        setTimeout(() => {
          showToast('Tap "Open" to load a PDF, then use Pen to sign', 4000);
        }, 500);
      }
    });

    // Prevent accidental navigation
    window.addEventListener('beforeunload', (e) => {
      if (pagesState.some(state => state.strokes.length > 0)) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
